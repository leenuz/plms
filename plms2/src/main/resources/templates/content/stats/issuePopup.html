<script src="/vendor/jquery/jquery.min.js"></script>
<link rel="stylesheet" href="/assets/css/popup/issuePopup.css">
 <script src="/vendor/exceljs.min.js"></script> 
<div id="searchResultsPopup">
    <div class="popupWrap active" id="popupWrap" style="width:60%">
        <h2>
            <p>잠재이슈 등록 필지 조회</p>
            <span class="topCloseBtn"></span>
        </h2>
        <div class="potential_issue_classification">
            <p>
                <span th:text="${depth1name}"></span>
                <span class="double_arrow"></span>
                <span th:text="${depth2name}"></span>
                <span class="double_arrow"></span>
                <span th:text="${depth3name}"></span>
            </p>
<!--            <button>-->
<!--                <p>엑셀 다운로드</p>-->
<!--                <figure>-->
<!--                    <img src="/assets/media/popup/images/download.png" alt="download" />-->
<!--                </figure>-->
<!--            </button>-->
        </div>
        <section class="potential_sec1">
            <p class="potential_total_num">
                <span>총 검색 건 수</span>
                <span class="num_blue" id="totalCount"></span>
                <span>건</span>
            </p>
            <!-- 잠재이슈 테이블 -->
            <div class="popupCont">
                <ul class="popTitles">
                    <li class="popTitle05">순번 </li>
                    <li class="popTitle07">발생지사</li>
                    <li class="popTitle06">주소 </li>
                    <li class="popTitle07">토지유형</li>
                    <li class="popTitle07">권리확보 </li>
                    <li class="popTitle07">자산번호</li>
                    <li class="popTitle07">관리번호</li>
                    <li class="popTitle07">취득일 </li>
                    <li class="popTitle01">점용기간 </li>
                    <li class="popTitle07">점용료 납부일</li>
                </ul>


                <!-- 잠재이슈 테이블 내용 추가되는 부분 -->
                <div class="popContentBox" id="resultList">
                </div>
            </div>
        </section>
        <section>
            <div class="pilji_info_Popup_boardPageBoxs">
                <ul>
                    <li class="arrowLeftWrapper">
                        <button onclick="firstPage()">
                            <img src="/assets/media/popup/images/arrowRightLine02.png" alt="preBtnImg" />
                        </button>
                        <button onclick="prevPage()">
                            <img src="/assets/media/popup/images/arrowRightLine01.png" alt="preBtnImg" />
                        </button>
                    </li>
                    <li class="pageCountBoxs" id="pagination">
                        <p>1</p>
                    </li>
                    <li class="arrowRightWrapper">
                        <button onclick="nextPage()">
                            <img src="/assets/media/popup/images/arrowRightLine01.png" alt="nextBtnImg" />
                        </button>
                        <button onclick="lastPage()">
                            <img src="/assets/media/popup/images/arrowRightLine02.png" alt="nextBtnImg" />
                        </button>
                    </li>
                </ul>
            </div>
        </section>

        <div class="lastBtnBox btnWrap">
            <button class="backbtn finalBtn" id="popupCloseBtn" style="background: #919191;">닫기</button>
            <button class="backbtn finalBtn" id="excelDownloadBtn" style="background: green;">엑셀다운로드</button>
        </div>
    </div>
</div>
<script>
    var pageNum = 0;
    var pageNo = 1;
    var totalCount = 0;
    var jisa = '[[${jisa}]]';
    var depth1 = '[[${depth1code}]]';
    var depth2 = '[[${depth2code}]]';
    var depth3 = '[[${depth3code}]]';
    var resultData = [];

    function loadData() {
        var allData = 'JISA=' + jisa + '&pageNum=' + pageNo + '&pageCnt=10';
        allData += '&SEARCH_CODE_1=' + depth1 + '&SEARCH_CODE_2=' + depth2 + '&SEARCH_CODE_3=' + depth3;

        $.ajax({
            url: "/statics/selectPotentialIssuePnuListByCode?" + allData,
            data: JSON.stringify(allData),
            async: true,
            type: "POST",
            dataType: "json",
            contentType: 'application/json; charset=utf-8',
            success: function (response) {
              console.log(response);
<!--              if (response.success = "Y") {-->
                totalCount = response.TOTALCNT;
                resultData = response.dataList;

                $('#totalCount').html(totalCount);
                pageNum = Math.floor(totalCount / 10);
                if (totalCount % 10 > 0) {
                    pageNum += 1;
                }

                display();
<!--              }-->
            },
            error: function () {
            }
        });
    }
    loadData();

    function display() {
        var startIdx = (pageNo - 1) * 10;

        var resultStr = '';
        for (var i = 0; i < resultData.length; i++) {
            var row = resultData[i];

            var seq = (pageNo - 1) * 10 + 1 + i;
            var toji = row.gover_own_yn == 'Y' ? '국유지' : '사유지';
            resultStr += '<ul class="popContents">';
            resultStr += '<li class="popContent05"><p>'+(seq)+'</p></li>';
            resultStr += '<li class="popContent07"><p>'+row.jisa+'</p></li>';
            resultStr += '<li class="popContent06"><p>'+row.juso+'</p></li>';
            resultStr += '<li class="popContent07"><p>'+toji+'</p></li>';
            resultStr += '<li class="popContent07"><p>권리확보</p></li>';
            resultStr += '<li class="popContent07"><p>'+row.jasan_no+'</p></li>';
            resultStr += '<li class="popContent07"><p>'+row.jisang_no+'</p></li>';
            resultStr += '<li class="popContent07"><p>'+row.chuideuk_date+'</p></li>';
            resultStr += '<li class="popContent01"><p>'+row.gover_period+'</p></li>';
            resultStr += '<li class="popContent07"><p>'+row.pay_date+'</p></li>';
            resultStr += '</ul>';
        }

        $('#resultList').html(resultStr);

        // pagination
        var pagiStr = '';
        var startNo = Math.floor((pageNo - 1) / 5) * 5 + 1;
        var endNo = startNo + 5 < pageNum + 1 ? startNo + 5 : pageNum + 1;
        for (var i = startNo; i < endNo; i++) {
            if (i == pageNo) {
                pagiStr += '<p class="active" onclick="goPage(' + i + ')">' + i + '</p>';
            } else {
                pagiStr += '<p onclick="goPage(' + i + ')">' + i + '</p>';
            }
        }
        $('#pagination').html(pagiStr);
    }

    function prevPage() {
        if (pageNo > 1) {
            pageNo -= 1;
            loadData();
        }
    }

    function nextPage() {
        if (pageNo < pageNum) {
            pageNo += 1;
            loadData();
        }
    }

    function firstPage() {
        pageNo = 1;
        loadData();
    }

    function lastPage() {
        pageNo = pageNum;
        loadData();
    }

    function goPage(no) {
        pageNo = no;
        loadData();
    }
    
    
    
    
    $(document).on("click","#excelDownloadBtn",function(){

    	
    	
    	console.log("---------excelDownloadBtn-------");
    	
    	 var allData = 'JISA=' + jisa + '&pageNum=' + pageNo + '&pageCnt=10';
         allData += '&SEARCH_CODE_1=' + depth1 + '&SEARCH_CODE_2=' + depth2 + '&SEARCH_CODE_3=' + depth3;

         $.ajax({
             url: "/statics/selectPotentialIssuePnuListByCodeExcel?" + allData,
             data: JSON.stringify(allData),
             async: true,
             type: "POST",
             dataType: "json",
             contentType: 'application/json; charset=utf-8',
             success: function (response) {
               console.log(response);

                 var data=response.dataList;
               
                 
                 var dataArr=[];
					var head=['순번','발생지사','주소','토지유형','권리확보','자산번호','관리번호','취득일','점용기간','점용료 납부일'];
					 dataArr.push(head);	
					for(var i=0;i<data.length;i++){
						var togi_type="";
						if (data[i].gover_own_yn=="Y") togi_type="국유지";
						else togi_type="사유지";
						var jisangStatus="";
						var jisangStatusTmp = data[i].jisang_status ? data[i].jisang_status.toLowerCase() : '';
						if (jisangStatusTmp=="jisang") jisangStatus="지상권";
						else if (jisangStatusTmp=="gover") jisangStatus="점용";
						else if (jisangStatusTmp=="notset") jisangStatus="미설정";
						else if (jisangStatusTmp=="dopco") jisangStatus="매입";
						else jisangStatus="";
						var pmtDate = data[i].pmt_st_date == undefined ? "" : data[i].pmt_st_date + " ~ " + data[i].pmt_ed_date; //점용기간
						var occunonpayreasonTitle1 ="";
						var occunonpayreasonTitle2 ="";
						//var occunonpayreasonTitle3 ="";
						if (data[i].occunonpayreason==1) occunonpayreasonTitle1="영구 무상점용";
						if (data[i].occunonpayreason==2) occunonpayreasonTitle1="소액 미청구";
						//if (data[i].occunonpayreason==2) occunonpayreasonTitle1="소액 미청구";
						
						
						var rowArr=[data[i].rn,data[i].jisa,data[i].juso,togi_type,jisangStatus,data[i].jasan_no,data[i].jisang_no,data[i].chuideuk_date,'',''];
						dataArr.push(rowArr);	
					}
					console.log("--------------excel data------------------");
					console.log(dataArr);
					
					
					// ExcelJS를 이용해 워크북과 워크시트 생성
			          var workbook = new ExcelJS.Workbook();
			          var worksheet = workbook.addWorksheet('Sheet1');

			          // 헤더와 데이터 추가 (빈 셀도 미리 생성)
			          worksheet.columns = head.map(h => ({ header: h, key: h, width: 20 }));
					  dataArr.slice(1).forEach(row => {
					          var rowObject = worksheet.addRow(row);
					          rowObject.eachCell({ includeEmpty: true }, function(cell, colNumber) {
					              cell.value = cell.value || '';  // 공백일 경우 빈 문자열로 초기화
					          });
					      });

						  
						
						  
			          // 스타일 정의 (글꼴, 테두리, 정렬)
			          worksheet.eachRow((row, rowNumber) => {
						if (rowNumber>1){
							row.eachCell((cell, colNumber) => {
				                  cell.font = { size: 10, bold: false };
				                  cell.alignment = { vertical: 'middle', horizontal: 'center' };
				                  cell.border = {
				                      top: { style: 'thin' },
				                      left: { style: 'thin' },
				                      bottom: { style: 'thin' },
				                      right: { style: 'thin' }
				                  };
				              });
						}
						else{
							row.eachCell((cell, colNumber) => {
				                  cell.font = { size: 12, bold: true };
				                  cell.alignment = { vertical: 'middle', horizontal: 'center' };
				                  cell.border = {
				                      top: { style: 'thin' },
				                      left: { style: 'thin' },
				                      bottom: { style: 'thin' },
				                      right: { style: 'thin' }
				                  };
				              });
						}
			              
			          });

					  
					  var unixTime = Date.now();
					      var fileName = '[잠재이슈필지]전체.xlsx';  // 파일명 생성
			          // 엑셀 파일 다운로드
			          workbook.xlsx.writeBuffer().then(function (buffer) {
			              var blob = new Blob([buffer], { type: 'application/octet-stream' });
			              var link = document.createElement('a');
			              link.href = URL.createObjectURL(blob);
			              link.download = fileName;
			              link.click();
			          });
					

             },
             error: function () {
             }
         });
	})
	
</script>