<html>
<head>
	<meta charset="UTF-8">
<title>TMS TEST 0.0.1</title>
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/openlayers@4.6.5/dist/ol.min.css"> -->
<style>
.map{
height:800px;
width:50%;
}
</style>
<script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="./xlsx.min.js"></script>


<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/openlayers/8.2.0/index.js" integrity="sha512-+o0vxcUhkW07ZmZ3vD13Wgt0bzTXqmUIbqNSyCWfBiEv8Ziq9BExylSJTQVjEvT6YU2Ob6Bq1MUPDnwn7U6Mng==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->
<!---<script src="https://cdn.jsdelivr.net/npm/openlayers@4.6.5/dist/ol.min.js"></script>--->
<!-- <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v6.1.1/build/ol.js"></script> -->
<!-- <link rel="stylesheet" href="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v6.1.1/css/ol.css"> -->





<script>
	
var mode=null;
if (mode==null){
var lang="undefined";

if(navigator.language != null) lang = navigator.language; // 언어 값이 있을 경우 lang에 저장
console.log(lang);
lang = lang.toLowerCase().substring(0.2); // 저장된 언어 값을 0부터 2까지 자르고 소문자로 변환하여 lang에 저장
}
else lang=mode;
console.log(lang);

</script>

<style>
	* { padding:0; margin:0;}
html, body { height:100%; }
.parent {
  overflow: hidden;
 
}

.child {
  float: left;
   height:100%;
  overflow-y:auto;
}

#response-container {
  background-color: #fff;
  border: 0;
  border-radius: 2px;
  box-shadow: 0 1px 4px -1px rgba(0, 0, 0, 0.3);
  margin: 10px;
  padding: 0 0.5em;
  font: 400 18px Roboto, Arial, sans-serif;
  overflow: hidden;
  overflow: auto;
  max-height: 50%;
  max-width: 90%;
  background-color: rgba(255, 255, 255, 0.95);
  font-size: small;
}
</style>
</head>
<body class="parent" style="height:100%">

		

  
    <div class="child" style="width:20%">

		   
		   <div style="width:100%;">
		    <div>geocoding google</div>
		     디비명:<input  id="dbname"></input>
		    <input type="file" id="my_file_input">
		   
		   
		  </div>
		  <hr>
		  <div style="width:100%;">
		    <div>엑셀파일 인덱스 빈것 찾기</div>
		    <input type="file" multiple="multiple" id="my_file_input1">
		   <input  id="compare_key"></input>
		    <button id="geocodegooglesend1">전송</button>
		  </div>
		  
		  <p>111</p>
		
	</div>
	<div class="child" id="map" style="height:100%;width:80%;"></div>
  
  




  
<script>
	




const downloadExcel = (data) => {
    const worksheet = XLSX.utils.json_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, 'my_sheet');
    XLSX.writeFile(workbook, 'json_to_excel.xlsx');
};

	
$(document).on("click","#tmsgeocodesend",function(){
	
	const allData=$("#geoData").val();
	url="http://localhost:8080/api/geoCode";
	
	tmsGeoCodeCall(allData);

	
});

function tmsGeoCodeCall(data){

	var url="";
var orsurl="";

	url="http://localhost:8080/api/geoCode";

$.ajax({

  url: url,
  data: data,
  async: true,
  type:"POST",
  dataType: "json",
  contentType: 'application/json; charset=utf-8',
  success: function(rt,jqXHR) {
	  console.log("----------------------------------------------");
    console.log(rt);
   // console.log(rt.result_data.resultData.vehicleList);
  
  
  },
  beforeSend: function() {
    //(이미지 보여주기 처리)
    //$('#load').show();
  },
  complete: function() {
    //(이미지 감추기 처리)
    //$('#load').hide();


  },
  error: function(jqXHR, textStatus, errorThrown,responseText) {
    //alert("ajax error \n" + textStatus + " : " + errorThrown);

   // console.log(jqXHR);
   // console.log(jqXHR.readyState);
   // console.log(jqXHR.responseText);
   // console.log(jqXHR.responseJSON);

  }
})

	
}


$(document).on("change","#my_file_input",function(e){
	console.log("start my_file_input");
	 var files = e.target.files; //input file 객체를 가져온다.
    var i,f;
    var headers;
    var EXCEL_JSON;
    for (i = 0; i != files.length; ++i) {
        f = files[i];
        var reader = new FileReader(); //FileReader를 생성한다.         
        
        //성공적으로 읽기 동작이 완료된 경우 실행되는 이벤트 핸들러를 설정한다.
        reader.onload = function(e) {
             
          // ...엑셀파일을 읽어서 처리하는 로직...
           var data = e.target.result; //FileReader 결과 데이터(컨텐츠)를 가져온다.
 
           //바이너리 형태로 엑셀파일을 읽는다.
           var workbook = XLSX.read(data, {type: 'binary'});
           
           //엑셀파일의 시트 정보를 읽어서 JSON 형태로 변환한다.
           workbook.SheetNames.forEach(function(item, index, array) {
			    headers=get_header_row(workbook.Sheets[item]);
			   console.log(headers);
               EXCEL_JSON = XLSX.utils.sheet_to_json(workbook.Sheets[item]);
             // console.log(EXCEL_JSON);
              	
           });//end. forEach
           
           //excel 내용 header와 비교해서 공백이라 안넘어온 header 빈정보 삽입
           for(j=0;j<headers.length;j++){
			  		for(jj=0;jj<EXCEL_JSON.length;jj++){
						  
						  if (!EXCEL_JSON[jj].hasOwnProperty(headers[j])){
							  
						//	console.log(jj+"="+headers[j]);
							//console.log(EXCEL_JSON[jj]);
							EXCEL_JSON[jj][headers[j]]="";  
						  }
					  }	
		   		}
               
           
           
                 // console.log(EXCEL_JSON);
                //  console.log(""+EXCEL_JSON.length);
                 
                  //EXCEL_JSON.length
                 // for(i=0;i<10;i++){
					 // console.log(EXCEL_JSON[i].ADDRESS+"|"+EXCEL_JSON[i].ZIPCODE);
					   var allData={"exceljson":EXCEL_JSON,"dbname":$("#dbname").val()}
					   console.log(allData);
					  $.ajax({

					    url: "http://localhost:8080/data/migration",
					    data:JSON.stringify(allData),
					    async: true,
					    type:"POST",
					    dataType: "json",
					    contentType: 'application/json; charset=utf-8',
					    success: function(rt,jqXHR) {
					      console.log(rt.results);
					      downloadExcel(rt.results);
					    },
					    beforeSend: function() {
					      //(이미지 보여주기 처리)
					      //$('#load').show();
					    },
					    complete: function() {
					      //(이미지 감추기 처리)
					      //$('#load').hide();
					
					
					    },
					    error: function(jqXHR, textStatus, errorThrown,responseText) {
					      //alert("ajax error \n" + textStatus + " : " + errorThrown);
					
					      console.log(jqXHR);
					      console.log(jqXHR.readyState);
					      console.log(jqXHR.responseText);
					      console.log(jqXHR.responseJSON);
					
					    }
					  }) //end ajax 
					//  setTimeout(() => console.log("after"), 1000);
				//  } //end for
           
        }; //end onload
      
        //파일객체를 읽는다. 완료되면 원시 이진 데이터가 문자열로 포함됨.
        reader.readAsBinaryString(f);
       
    }//end. for

});



$(document).on("change","#my_file_input1",function(e){
	console.log("start my_file_input1");
	 var files = e.target.files; //input file 객체를 가져온다.
	console.log("file size:"+files.length);
    var i;
    var EXCEL_ARR=new Array();
    for (i = 0; i < files.length; i++) {
		console.log("i="+i);
        var f = files[i];
        console.log(f.name);
        
        var reader = new FileReader(); //FileReader를 생성한다.         
        
        //성공적으로 읽기 동작이 완료된 경우 실행되는 이벤트 핸들러를 설정한다.
        reader.onload = function(e) {
             
          // ...엑셀파일을 읽어서 처리하는 로직...
           var data = e.target.result; //FileReader 결과 데이터(컨텐츠)를 가져온다.
 
           //바이너리 형태로 엑셀파일을 읽는다.
           var workbook = XLSX.read(data, {type: 'binary'});
          ;
           //엑셀파일의 시트 정보를 읽어서 JSON 형태로 변환한다.
           console.log("sheet count="+workbook.SheetNames.language);
           workbook.SheetNames.forEach(function(item, index, array) {
			    console.log(workbook.Sheets[item]);
               var EXCEL_JSON=XLSX.utils.sheet_to_json(workbook.Sheets[item]);
             	EXCEL_ARR.push(EXCEL_JSON);
               
           });//end. forEach
           
                  
           
        }; //end onload
      
        //파일객체를 읽는다. 완료되면 원시 이진 데이터가 문자열로 포함됨.
        reader.readAsBinaryString(f); 
       
    }//end. for
    
    //비교시작
    	console.log(EXCEL_ARR);
    	console.log(EXCEL_ARR[0]);
          //        console.log(""+EXCEL_JSON.length);
                 
                  //EXCEL_JSON.length
                /*  for(i=1,j=0;i<EXCEL_ARR[0].length;i++,j++){
					 // console.log(EXCEL_JSON[i].ADDRESS+"|"+EXCEL_JSON[i].ZIPCODE);
				//	   var allData={"zip":EXCEL_JSON[i].ZIPCODE,"address":EXCEL_JSON[i].ADDRESS}
					   console.log("no="+EXCEL_ARR[0].no);
						//console.log("i="+i+" ,j="+j+", no="+EXCEL_JSON[j].no);
						if (i!=parseInt(EXCEL_ARR[j].no)){
							console.log("i="+i+" ,j="+j+", no="+EXCEL_JSON[j].no);
							j--;
							continue;
							//i=parseInt()
						}
					
					 //if (i!=EXCEL_JSON[i-1].no) console.log("i="+i+" no="+EXCEL_JSON[i-1].no);
					//  setTimeout(() => console.log("after"), 1000);
				  } //end for  */
    
    

});


function get_header_row(sheet) {
    var headers = [];
    var range = XLSX.utils.decode_range(sheet['!ref']);
    var C, R = range.s.r; /* start in the first row */
    /* walk every column in the range */
    for(C = range.s.c; C <= range.e.c; ++C) {
        var cell = sheet[XLSX.utils.encode_cell({c:C, r:R})] /* find the cell in the first row */

        var hdr = "UNKNOWN " + C; // <-- replace with your desired default 
        if(cell && cell.t) hdr = XLSX.utils.format_cell(cell);

        headers.push(hdr);
    }
    return headers;
}


</script>
 
</body>

</html>
